<!DOCTYPE html>
<html>
<head>
  <title>Content Encryption Tool</title>
  <style>
    body { font-family: sans-serif; }
    #encryptionTool { max-width: 600px; margin: 0 auto; padding: 20px; }
    textarea { width: 100%; height: 200px; margin-bottom: 10px; white-space: pre-wrap;} 
    button { padding: 8px 15px; }
    #statusMessage { margin-top: 10px; } /* Added for displaying status messages */
  </style>
</head>
<body>
  <div id="encryptionTool">
    <h2>Content Encryption Tool</h2>

    <label for="inputKey">Encryption Key (default: 4444):</label>
    <input type="text" id="inputKey" value="4444">

    <label for="inputContent">Content to Encrypt (Paste your SPA HTML here):</label>
    <textarea id="inputContent"></textarea>
    
    <br>

    <label for="outputContent">Encrypted Content:</label>
    <textarea id="outputContent" readonly></textarea>

    <button id="encryptButton">Encrypt</button>
    <p id="statusMessage"></p> 
  </div>

  <script>
    const inputKey = document.getElementById('inputKey');
    const inputContent = document.getElementById('inputContent');
    const outputContent = document.getElementById('outputContent');
    const statusMessage = document.getElementById('statusMessage'); 

    async function encryptContent(content, key) {
      const encoder = new TextEncoder();
      const data = encoder.encode(content);
      const keyData = encoder.encode(key); 

      const importedKey = await crypto.subtle.importKey(
        "raw", keyData, {name: "HMAC", hash: "SHA-256"}, false, ["sign"]
      );

      const signature = await crypto.subtle.sign("HMAC", importedKey, data);
      const signatureArray = Array.from(new Uint8Array(signature));

      const signatureHex = signatureArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return signatureHex + content;
    }
    
    async function decryptContent(encryptedContent, key) {
      const encoder = new TextEncoder();
      const keyData = encoder.encode(key);

      const signatureHex = encryptedContent.substring(0, 64);
      const originalContent = encryptedContent.substring(64);

      const signatureArray = new Uint8Array(signatureHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));

      const importedKey = await crypto.subtle.importKey(
        "raw", keyData, {name: "HMAC", hash: "SHA-256"}, false, ["verify"]
      );

      const isSignatureValid = await window.crypto.subtle.verify(
        "HMAC", importedKey, signatureArray, encoder.encode(originalContent)
      );

      if (isSignatureValid) {
        return originalContent;
      } else {
        throw new Error('Invalid decryption key or content has been tampered with.');
      }
    }
  
    function updateEncryptedContent() {
      const content = inputContent.value; // Get the entire content

      encryptContent(content, inputKey.value)
        .then(async (encrypted) => {
            try{
                const decrypted = await decryptContent(encrypted, inputKey.value);
                if (decrypted === content){
                    outputContent.value = encrypted;
                    statusMessage.textContent = "Encryption/Decryption successful!";
                } else {
                    throw new Error('Decryption failed.');
                }

            } catch (error) {
                console.error('Decryption error:', error);
                outputContent.value = "Error encrypting content";
            }
        })
        .catch(error => {
          console.error('Encryption error:', error);
          outputContent.value = "Error encrypting content";
        });
    }

    inputKey.addEventListener('input', updateEncryptedContent);
    inputContent.addEventListener('input', updateEncryptedContent);

    // Make the encrypted content copyable
    outputContent.addEventListener('click', () => {
      outputContent.select();
      document.execCommand('copy');
    });

    // Initial encryption (after a short delay to ensure content is loaded)
    setTimeout(updateEncryptedContent, 500); 
  </script>
</body>
</html>

